<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prevention & Screening Tool</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2c;
      --muted:#9fb1d1;
      --text:#e8efff;
      --line:rgba(255,255,255,.10);
      --ok:#3ddc97;
      --due:#ffcc66;
      --hi:#ff6b6b;
      --btn:#1e2d4e;
      --btn2:#24385f;
      --shadow:0 18px 45px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(67,114,255,.20), transparent 60%),
        radial-gradient(780px 520px at 80% 20%, rgba(61,220,151,.12), transparent 60%),
        radial-gradient(900px 520px at 70% 90%, rgba(255,204,102,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}

    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 16px;
      background:rgba(17,26,44,.85);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, rgba(67,114,255,.9), rgba(61,220,151,.8));
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.18);
    }
    .logo span{font-weight:900;color:#071126;letter-spacing:.5px}
    .title{line-height:1.1}
    .title h1{margin:0;font-size:18px}
    .title p{margin:4px 0 0;color:var(--muted);font-size:12px}

    .nav{
      display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;
    }
    .tab{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .tab:hover{background:var(--btn2)}
    .tab.active{
      outline:2px solid rgba(67,114,255,.55);
      background:rgba(67,114,255,.20);
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
      .nav{justify-content:flex-start}
    }

    .card{
      background:rgba(17,26,44,.88);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .card .hd h2{margin:0;font-size:15px}
    .card .hd .sub{margin:4px 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding:14px 16px}

    .note{
      padding:12px 12px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius:var(--radius2);
      color:var(--muted);
      background:rgba(255,255,255,.04);
      font-size:13px;
      line-height:1.4;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px;min-width:180px;flex:1}
    label{font-size:12px;color:var(--muted);font-weight:700}
    input,select,textarea{
      width:100%;
      padding:10px 11px;
      background:rgba(7,17,38,.65);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    input::placeholder,textarea::placeholder{color:rgba(159,177,209,.75)}
    textarea{min-height:110px;resize:vertical;font-family:var(--mono);font-size:12.5px}

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{background:var(--btn2)}
    .btn.primary{background:rgba(61,220,151,.16); outline:2px solid rgba(61,220,151,.25)}
    .btn.danger{background:rgba(255,107,107,.14); outline:2px solid rgba(255,107,107,.22)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-size:12px;color:var(--muted);font-weight:700;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.35)}
    .dot.ok{background:var(--ok)}
    .dot.due{background:var(--due)}
    .dot.hi{background:var(--hi)}

    .bucket{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(7,17,38,.55);
      border-radius:14px;
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:8px 0;
    }
    .bucket b{font-size:13px}
    .bucket small{color:var(--muted)}
    .bucket select{max-width:220px}

    .results .item{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(7,17,38,.55);
      border-radius:16px;
      padding:12px;
      margin:10px 0;
    }
    .results .item .top{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;gap:8px;align-items:center;
      padding:7px 10px;border-radius:999px;font-weight:900;font-size:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
    }
    .badge.ok{color:var(--ok)}
    .badge.due{color:var(--due)}
    .badge.high{color:var(--hi)}
    .results .item .msg{margin:8px 0 0;color:var(--text);font-size:13.5px;line-height:1.35}
    .results .item .src{margin:8px 0 0;color:var(--muted);font-size:12px}

    .footer{
      margin-top:12px;
      text-align:center;
      color:rgba(159,177,209,.75);
      font-size:12px;
      padding:10px 0 2px;
    }
    .footer b{color:rgba(232,239,255,.85)}
    .tiny{font-size:11px;color:rgba(159,177,209,.65)}

    /* Risk chips */
    .riskGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){ .riskGrid{grid-template-columns:1fr} }

    .riskChip{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(7,17,38,.55);
      border-radius:14px;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      transition:.15s ease;
    }
    .riskChip:hover{background:rgba(7,17,38,.70)}
    .riskChip.on{
      outline:2px solid rgba(67,114,255,.55);
      background:rgba(67,114,255,.18);
    }
    .riskChip b{font-size:13px}
    .riskChip small{color:var(--muted);font-weight:700;font-size:12px}
    .riskChip .tag{
      font-weight:900;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:rgba(232,239,255,.88);
    }
    .riskChip.on .tag{
      border-color: rgba(67,114,255,.55);
      background: rgba(67,114,255,.20);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>PS</span></div>
        <div class="title">
          <h1>Prevention & Screening</h1>
          <p>Session-only preventive screening reminders.</p>
        </div>
      </div>

      <div class="nav" id="navTabs">
        <div class="tab active" data-page="welcome">Welcome</div>
        <div class="tab" data-page="demographics">Demographics</div>
        <div class="tab" data-page="risks">Risk Factors</div>
        <div class="tab" data-page="screening">Screening</div>
		<div class="tab" data-page="vaccinations">Vaccinations</div>
        <div class="tab" data-page="results">Results</div>
        <div class="tab" data-page="export">Export</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h2 id="leftTitle">Welcome</h2>
            <div class="sub" id="leftSub">How this tool works + sources</div>
          </div>
          <div class="pill" id="statusPill" title="Internal status">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">Ready</span>
          </div>
        </div>
        <div class="bd" id="leftPane"></div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h2 id="rightTitle">Quick Summary</h2>
            <div class="sub" id="rightSub">Age, BMI, and key flags</div>
          </div>
        </div>
        <div class="bd" id="rightPane"></div>
      </div>
    </div>

    <div class="footer">
      <div><span class="tiny">programed by</span> <b>Dr. Abdullah Hosni Alreedy</b></div>
      <div class="tiny">Prevention & Screening Tool V2</div>
    </div>
  </div>

  <script>
/* =========================================================
   BLOCK 1 ENDS HERE
   Next blocks will add: state + utilities + pages + engines.
   ========================================================= */
  </script>
</body>
</html>
<script>
/* =========================================================
   Prevention & Screening Tool (Session-only)
   Programed by Dr. Abdullah Hosni Alreedy
   ========================================================= */

/* =========================
   GLOBAL STATE (Session-only)
   ========================= */
const state = {
  page: "welcome",

  demographics: {
    sex: "male",        // "male" | "female"
    dobGregorian: "",   // "YYYY-MM-DD"
    age: null,          // calculated
    heightCm: "",       // optional
    weightKg: "",       // optional
    bmi: null,          // calculated
    pregnant: false,
    lmp: ""             // "YYYY-MM-DD" (if pregnant)
  },

  risks: {
    smoker: false,
    obesity: false,   // derived from BMI when available
    htn: false,
    dm: false,
    dyslipidemia: false,
    ckd: false,
    fhxPrematureCvd: false,
    fhxCrc: false
  },

  // Legacy buckets kept for compatibility
  screening: {
    htn: "unknown",
    dm: "unknown",
    lipids: "unknown",
    hiv: "unknown",
    hcv: "unknown",
    crc: "unknown",
    cervical: "unknown",
    breast: "unknown",
    osteoporosis: "unknown",
    aaa: "unknown",
    depression: "unknown"
  },

  // Session-only detail engines (no storage)
  screeningDetails: {
    crc: {
      done: null,
      lastDate: null,
      method: "",
      result: "unknown",
      fhxFDR: false,
      fhxAgeAtDx: "unknown",
      fhxNumFDR: "one",
      startAge: null,
      intervalYears: null,
      nextDue: null
    },
   generic: {
  htn:{ done:null,lastDate:null,intervalType:"RISK_BASED",intervalYears:null,nextDue:null,note:"" },
  dm:{ done:null,lastDate:null,intervalType:"ANNUAL",intervalYears:1,nextDue:null,note:"" },
  lipids:{ done:null,lastDate:null,intervalType:"POLICY",intervalYears:null,nextDue:null,note:"" },
  hiv:{ done:null,lastDate:null,intervalType:"ONE_TIME",intervalYears:null,nextDue:null,note:"" },
  hcv:{ done:null,lastDate:null,intervalType:"ONE_TIME",intervalYears:null,nextDue:null,note:"" },

  cervical:{ done:null,lastDate:null,intervalType:"BY_METHOD",intervalYears:null,nextDue:null,note:"",method:"" },
  breast:{ done:null,lastDate:null,intervalType:"POLICY",intervalYears:null,nextDue:null,note:"Policy-based.",method:"MAMMO" },
  osteoporosis:{ done:null,lastDate:null,intervalType:"POLICY",intervalYears:null,nextDue:null,note:"DXA per risk.",method:"DXA" },
  aaa:{ done:null,lastDate:null,intervalType:"ONE_TIME",intervalYears:null,nextDue:null,note:"One-time if eligible.",method:"US" },
  depression:{ done:null,lastDate:null,intervalType:"ANNUAL",intervalYears:1,nextDue:null,note:"Annual.",method:"PHQ" }
}

  },
  vaccinations: {
    // Each item is session-only
    // intervalType: "POLICY" (years) or "ONE_TIME"
    influenza:     { done:null, lastDate:null, intervalType:"POLICY", intervalYears:1,  nextDue:null, note:"Policy-based annual." },
    covid19:       { done:null, lastDate:null, intervalType:"POLICY", intervalYears:1,  nextDue:null, note:"Policy-based." },
    tdap:          { done:null, lastDate:null, intervalType:"POLICY", intervalYears:10, nextDue:null, note:"Policy-based booster interval." },
    pneumococcal:  { done:null, lastDate:null, intervalType:"ONE_TIME", intervalYears:null, nextDue:null, note:"Policy-based eligibility." },
    hepB:          { done:null, lastDate:null, intervalType:"ONE_TIME", intervalYears:null, nextDue:null, note:"Series completion (policy-based)." },
    hpv:           { done:null, lastDate:null, intervalType:"ONE_TIME", intervalYears:null, nextDue:null, note:"Series completion (policy-based)." },
    zoster:        { done:null, lastDate:null, intervalType:"ONE_TIME", intervalYears:null, nextDue:null, note:"Series completion (policy-based)." }
  },
  pregnancy: {
    // Session-only pregnancy follow-up tracker (GA-based)
    items: {
      datingScan:   { done:null, date:null, note:"Dating/NT scan window commonly 8–13 weeks." },
      nipt:         { done:null, date:null, note:"NIPT / cfDNA typically from 10 weeks (policy-based)." },
      anomalyScan:  { done:null, date:null, note:"Anomaly scan commonly 18–22 weeks." },
      gdmScreen:    { done:null, date:null, note:"GDM screen commonly 24–28 weeks." },
      gbs:          { done:null, date:null, note:"GBS screen commonly 35–37 weeks." }
    }
  },
   ui: {
    showNonEligible: false,
    exportMode: "progress", // "progress" | "patient"
    policy: "USPSTF"        // "USPSTF" | "LOCAL"
  },



  results: [], // computed
  flags: [], // session-only data-quality flags
  exportText: "" // computed
};


/* =========================
   UTILITIES
   ========================= */
function $(id){ return document.getElementById(id); }
/* =========================================================
   V2 BLOCK 3B
   Pregnancy helpers (GA/EDD + due window logic)
   ========================================================= */

function addDaysISO(isoDate, days){
  const d = parseISODate(isoDate);
  if(!d) return null;
  d.setDate(d.getDate() + Number(days));
  return d.toISOString().slice(0,10);
}

function getGAWeeksFromState(){
  const d = state.demographics;
  if(d.sex !== "female") return null;
  if(!d.pregnant) return null;
  if(!d.lmp) return null;

  const lmp = parseISODate(d.lmp);
  if(!lmp) return null;

  const diffMs = new Date().getTime() - lmp.getTime();
  const w = Math.floor(diffMs / (1000*60*60*24*7));
  if(w < 0) return null;
  return w;
}

function getEDDFromLMP(){
  const d = state.demographics;
  if(!d.lmp) return null;
  // 280 days = 40 weeks
  return addDaysISO(d.lmp, 280);
}

// Returns: "NOT_YET" | "DUE_NOW" | "OVERDUE" | "DONE" | "NA"
function gaWindowStatus(gaWeeks, done, startW, endW){
  if(gaWeeks === null) return "NA";
  if(done === true) return "DONE";
  if(gaWeeks < startW) return "NOT_YET";
  if(gaWeeks >= startW && gaWeeks <= endW) return "DUE_NOW";
  if(gaWeeks > endW) return "OVERDUE";
  return "NA";
}

function setStatus(kind, text){
  const dot = $("statusDot");
  const label = $("statusText");
  if(!dot || !label) return;

  dot.className = "dot";
  if(kind === "ok") dot.classList.add("ok");
  else if(kind === "due") dot.classList.add("due");
  else if(kind === "hi") dot.classList.add("hi");

  label.textContent = text || "Ready";
}

function clamp(n, a, b){
  const x = Number(n);
  if(Number.isNaN(x)) return null;
  return Math.max(a, Math.min(b, x));
}

function parseISODate(iso){
  if(!iso || typeof iso !== "string") return null;
  const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
  const dt = new Date(y, mo, d);
  if(dt.getFullYear() !== y || dt.getMonth() !== mo || dt.getDate() !== d) return null;
  return dt;
}
function formatISODate(dt){
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const d = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function todayISO(){ return new Date().toISOString().slice(0,10); }

function addYearsISO(isoDate, years){
  const d = parseISODate(isoDate);
  if(!d || !years) return null;
  const nd = new Date(d);
  nd.setFullYear(nd.getFullYear() + Number(years));
  return formatISODate(nd);
}
function isOnOrBeforeISO(a, b){
  const da = parseISODate(a);
  const db = parseISODate(b);
  if(!da || !db) return false;
  return da.getTime() <= db.getTime();
}

function calcAgeFromDob(dobISO){
  const dob = parseISODate(dobISO);
  if(!dob) return null;
  const now = new Date();
  let age = now.getFullYear() - dob.getFullYear();
  const m = now.getMonth() - dob.getMonth();
  if(m < 0 || (m === 0 && now.getDate() < dob.getDate())) age--;
  return age;
}

function calcBMI(heightCm, weightKg){
  const h = Number(heightCm), w = Number(weightKg);
  if(!h || !w) return null;
  const m = h / 100;
  const bmi = w / (m*m);
  return Math.round(bmi*10)/10;
}
/* =========================================================
   V2 BLOCK 1A
   Risk-based suggested interval for Lipids (non-binding)
   ========================================================= */
function suggestLipidsIntervalYears(){
  const r = state.risks;

  const highRisk =
    r.dm ||
    r.htn ||
    r.ckd ||
    r.smoker ||
    r.obesity;

  if (highRisk) return 1;   // yearly
  return 5;                 // default low risk
}
/* =========================================================
   V2 BLOCK 6B
   Policy selector helpers (session-only)
   ========================================================= */

function policyLabel(){
  return (state.ui.policy === "LOCAL") ? "LOCAL POLICY" : "USPSTF";
}

function cyclePolicy(){
  state.ui.policy = (state.ui.policy === "USPSTF") ? "LOCAL" : "USPSTF";
}

function applyPolicyHooks(){
  // Intentionally minimal in Block 6 to keep v1 logic stable.
  // This is the single place where later V2 blocks can adjust:
  // - default intervals
  // - eligibility toggles
  // - wording / sources
  // without breaking the app.
}

/* =========================
   NAVIGATION
   ========================= */
function setActiveTab(page){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.page === page);
  });
}

function go(page){
  state.page = page;
  setActiveTab(page);
  render();
}

function wireNav(){
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>go(t.dataset.page));
  });
}

/* =========================
   RIGHT PANE SUMMARY
   ========================= */
function renderRightPane(){
  const d = state.demographics;

  // derive obesity from BMI if available
  if(d.bmi !== null) state.risks.obesity = (d.bmi >= 30);

  const flags = [];
  if(state.risks.dm) flags.push("Known DM");
  if(state.risks.htn) flags.push("Known HTN");
  if(state.risks.ckd) flags.push("CKD");
  if(state.risks.smoker) flags.push("Smoker");
  if(state.risks.obesity) flags.push("Obesity");
  if(d.sex === "female" && d.pregnant) flags.push("Pregnant");

  $("rightPane").innerHTML = `
    <div class="note">
      <div><b>Sex:</b> ${d.sex}</div>
      <div><b>Age:</b> ${d.age ?? "—"}</div>
      <div><b>BMI:</b> ${d.bmi ?? "—"}</div>
      <div style="margin-top:8px"><b>Flags:</b> ${flags.length ? flags.join(", ") : "—"}</div>
      <div class="tiny" style="margin-top:10px">
        Session-only: nothing is stored after closing the page.
      </div>
    </div>
  `;
}

/* =========================
   PAGE TITLES
   ========================= */
function setHeaders(){
  const map = {
    welcome: ["Welcome", "Tool overview + sources"],
    demographics: ["Demographics", "Sex, DOB, BMI (session-only)"],
    risks: ["Risk Factors", "Click to highlight risk factors"],
    screening: ["Screening", "Enter Done/Date when available to calculate next due"],
	vaccinations: ["Vaccinations", "Session-only vaccine tracker (policy-based intervals)"],
    results: ["Results", "Due, recommended, and considerations"],
    export: ["Export", "Copy into your progress note"]
  };
  const [lt, ls] = map[state.page] || ["", ""];
  $("leftTitle").textContent = lt;
  $("leftSub").textContent = ls;
}

/* =========================
   RENDER SHELL
   ========================= */
function render(){
  setHeaders();
  renderRightPane();

  if(state.page === "welcome") renderWelcome();
  else if(state.page === "demographics") renderDemographics();
  else if(state.page === "risks") renderRisks();
  else if(state.page === "screening") renderScreening();
  else if(state.page === "vaccinations") renderVaccinations();
  else if(state.page === "results") renderResults();
  else if(state.page === "export") renderExport();
  else renderWelcome();
}

/* =========================================================
   PAGES (stubs for now - will be fully added in next blocks)
   ========================================================= */
/* =========================================================
   PAGES (Welcome + Demographics + Risks)
   ========================================================= */

function renderWelcome(){
  $("leftPane").innerHTML = `
    <div class="note">
      <b>What this tool does</b><br><br>
      This is a <b>session-only</b> preventive care assistant:
      <ul style="margin:8px 0 0 18px; color:rgba(159,177,209,.95); line-height:1.5">
        <li>Collects demographics and key risk factors.</li>
        <li>Allows marking screenings as <b>Done / Not done</b> with optional last date.</li>
        <li>Calculates <b>next due dates</b> for interval-based screenings.</li>
        <li>Generates a copyable summary for direct use in progress notes.</li>
      </ul>
      <div style="margin-top:10px">
        <b>Privacy:</b> No patient data is stored. Closing the page clears all entries.
      </div>
    </div>

    <div class="note" style="margin-top:12px">
      <b>Evidence-based References</b><br><br>

      <ul style="margin:8px 0 0 18px; line-height:1.6">
        <li>
          <b>USPSTF – Preventive Services Recommendations</b><br>
          <a href="https://www.uspreventiveservicestaskforce.org/uspstf/recommendation-topics/uspstf-and-b-recommendations"
             target="_blank" rel="noopener">
            https://www.uspreventiveservicestaskforce.org
          </a>
        </li>

        <li style="margin-top:8px">
          <b>ADA – Standards of Care in Diabetes</b><br>
          <a href="https://diabetesjournals.org/care/issue"
             target="_blank" rel="noopener">
            https://diabetesjournals.org/care
          </a>
        </li>

        <li style="margin-top:8px">
          <b>CDC – Screening & Prevention Guidelines</b><br>
          <a href="https://www.cdc.gov/prevention/index.html"
             target="_blank" rel="noopener">
            https://www.cdc.gov/prevention
          </a>
        </li>

        <li style="margin-top:8px">
          <b>ACOG – Women’s Preventive Care</b><br>
          <a href="https://www.acog.org/clinical"
             target="_blank" rel="noopener">
            https://www.acog.org/clinical
          </a>
        </li>

        <li style="margin-top:8px">
          <b>WHO – Screening & Early Detection</b><br>
          <a href="https://www.who.int/teams/noncommunicable-diseases/surveillance/systems-tools/steps"
             target="_blank" rel="noopener">
            https://www.who.int
          </a>
        </li>
      </ul>

      <div class="tiny" style="margin-top:10px">
        References are provided for clinical context. Local policies and institutional protocols may differ.
      </div>
    </div>

    <div class="btns">
	  <div class="btn" onclick="cyclePolicy(); applyPolicyHooks(); renderWelcome();">Policy: ${policyLabel()}</div>
      <div class="btn primary" onclick="go('demographics')">Start</div>
      <div class="btn" onclick="go('risks')">Risk Factors</div>
      <div class="btn" onclick="go('screening')">Screening</div>
      <div class="btn" onclick="go('export')">Export</div>
    </div>
  `;
  setStatus("ok","Ready");
}


function renderDemographics(){
  const d = state.demographics;

  // Compute age/BMI (live)
  if(d.dobGregorian){
    d.age = calcAgeFromDob(d.dobGregorian);
  } else {
    d.age = null;
  }

  d.bmi = calcBMI(d.heightCm, d.weightKg);

  // Obesity derived (do not override manual risks except obesity)
  if(d.bmi !== null) state.risks.obesity = (d.bmi >= 30);

  // Pregnancy/LMP appear ONLY if female
  if(d.sex !== "female"){
    d.pregnant = false;
    d.lmp = "";
  }

  // Simple GA estimate (weeks) from LMP when pregnant
  let gaWeeks = null;
  if(d.sex === "female" && d.pregnant && d.lmp){
    const lmp = parseISODate(d.lmp);
    if(lmp){
      const diffMs = new Date().getTime() - lmp.getTime();
      gaWeeks = Math.floor(diffMs / (1000*60*60*24*7));
      if(gaWeeks < 0) gaWeeks = null;
    }
  }

  $("leftPane").innerHTML = `
    <div class="row">
      <div class="field">
        <label>Sex</label>
        <select onchange="
          state.demographics.sex=this.value;
          // Ensure pregnancy fields are consistent immediately
          if(this.value!=='female'){ state.demographics.pregnant=false; state.demographics.lmp=''; }
          renderDemographics(); renderRightPane();
        ">
          <option value="male" ${d.sex==="male"?"selected":""}>Male</option>
          <option value="female" ${d.sex==="female"?"selected":""}>Female</option>
        </select>
      </div>

      <div class="field">
        <label>Date of birth (Gregorian)</label>
        <input type="date" value="${d.dobGregorian}"
          onchange="state.demographics.dobGregorian=this.value; renderDemographics(); renderRightPane();">
      </div>

      <div class="field">
        <label>Age (auto)</label>
        <input type="text" value="${d.age ?? ""}" placeholder="Calculated automatically" readonly>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="field">
        <label>Height (cm)</label>
        <input type="number" inputmode="decimal" min="0" step="0.1" value="${d.heightCm}"
          placeholder="e.g., 170"
          onchange="state.demographics.heightCm=this.value; renderDemographics(); renderRightPane();">
      </div>

      <div class="field">
        <label>Weight (kg)</label>
        <input type="number" inputmode="decimal" min="0" step="0.1" value="${d.weightKg}"
          placeholder="e.g., 82"
          onchange="state.demographics.weightKg=this.value; renderDemographics(); renderRightPane();">
      </div>

      <div class="field">
        <label>BMI (auto)</label>
        <input type="text" value="${d.bmi ?? ""}" placeholder="Calculated automatically" readonly>
      </div>
    </div>

    ${
      d.sex === "female" ? `
      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>Pregnant?</label>
          <select onchange="
            state.demographics.pregnant = (this.value==='yes');
            if(!state.demographics.pregnant){ state.demographics.lmp=''; }
            renderDemographics(); renderRightPane();
          ">
            <option value="no" ${d.pregnant===false?"selected":""}>No</option>
            <option value="yes" ${d.pregnant===true?"selected":""}>Yes</option>
          </select>
        </div>

        <div class="field">
          <label>LMP (Gregorian) ${d.pregnant ? "" : "(disabled)"}</label>
          <input type="date" value="${d.lmp}" ${d.pregnant ? "" : "disabled"}
            onchange="state.demographics.lmp=this.value; renderDemographics(); renderRightPane();">
        </div>

        <div class="field">
          <label>Gestational age (weeks) (auto)</label>
          <input type="text" value="${(d.pregnant && gaWeeks!==null) ? gaWeeks : ""}" readonly>
        </div>
      </div>
      ` : ``
    }

    <div class="note" style="margin-top:12px">
      <b>Notes</b><br>
      • BMI is calculated automatically when height and weight are entered.<br>
      • Obesity risk factor is derived from BMI (BMI ≥ 30).<br>
      • Pregnancy fields appear only when Sex = Female.
    </div>

    <div class="btns">
      <div class="btn" onclick="go('welcome')">Back</div>
      <div class="btn primary" onclick="go('risks')">Next: Risk Factors</div>
    </div>
  `;

  setStatus("ok","Demographics");
}

function renderRisks(){
  const r = state.risks;

  // Keep obesity derived from BMI when BMI exists
  const bmi = state.demographics.bmi;
  if(bmi !== null) r.obesity = (bmi >= 30);

  const chip = (key, title, subtitle, locked=false) => {
    const on = !!r[key];
    const cls = `riskChip ${on ? "on" : ""} ${locked ? "locked" : ""}`;
    const tag = on ? "ON" : "OFF";
    const lockNote = locked ? `<div class="tiny">Auto from BMI</div>` : `<div class="tiny">Click to toggle</div>`;
    return `
      <div class="${cls}" onclick="
        if(${locked}) return;
        state.risks['${key}']=!state.risks['${key}'];
        renderRisks(); renderRightPane();
      ">
        <div>
          <b>${title}</b><br>
          <small>${subtitle}</small>
          ${lockNote}
        </div>
        <div class="tag">${tag}</div>
      </div>
    `;
  };

  $("leftPane").innerHTML = `
    <div class="note">
      Click a risk factor to highlight it. These risk factors inform screening intensity and intervals.
    </div>

    <div class="riskGrid" style="margin-top:12px">
      ${chip("smoker","Tobacco use","Current smoker",false)}
      ${chip("obesity","Obesity","BMI ≥ 30 (derived from BMI)", (bmi !== null))}

      ${chip("htn","Known hypertension","Patient is a known HTN case",false)}
      ${chip("dm","Known diabetes","Patient is a known DM case",false)}

      ${chip("dyslipidemia","Dyslipidemia","Known hyperlipidemia",false)}
      ${chip("ckd","Chronic kidney disease","CKD (any stage)",false)}

      ${chip("fhxPrematureCvd","Family history premature CVD","First-degree relative: early CVD",false)}
      ${chip("fhxCrc","Family history of CRC","CRC / advanced adenoma in first-degree relative",false)}
    </div>

    <div class="note" style="margin-top:12px">
      <b>Important:</b> This tool is session-only and does not store patient information.
    </div>

    <div class="btns">
      <div class="btn" onclick="go('demographics')">Back</div>
      <div class="btn primary" onclick="go('screening')">Next: Screening</div>
    </div>
  `;

  setStatus("ok","Risk factors");
}



/* =========================================================
   SCREENING ENGINES + WIZARDS (BLOCK 4A)
   - CRC wizard (method/date/FHx → next due)
   - HTN wizard (risk-based → next due)
   - DM screening wizard (annual default → next due)
   ========================================================= */

// ---------- Small UI helper (legacy bucket row for later use) ----------
function bucketRow(title, key, help){
  const v = state.screening[key] || "unknown";
  return `
    <div class="bucket">
      <div>
        <b>${title}</b><br>
        <small>${help || ""}</small>
      </div>
      <select onchange="state.screening['${key}']=this.value; renderScreening();">
        <option value="unknown" ${v==="unknown"?"selected":""}>Unknown</option>
        <option value="recent" ${v==="recent"?"selected":""}>Up to date</option>
        <option value="overdue" ${v==="overdue"?"selected":""}>Overdue</option>
        <option value="never" ${v==="never"?"selected":""}>Never done</option>
      </select>
    </div>
  `;
}

// ---------- Generic wizard helpers ----------
function genericStatusBadge(bucketVal){
  if(bucketVal === "recent") return `<span class="badge ok">OK</span>`;
  if(bucketVal === "overdue" || bucketVal === "never") return `<span class="badge due">DUE</span>`;
  return `<span class="badge high">CONSIDER</span>`;
}
function genericDoneValueToText(v){
  if(v === true) return "Done";
  if(v === false) return "Not done";
  return "Unknown";
}

// ---------- Generic calculator (session-only) ----------
function calcNextDueGeneric(key){
  const g = state.screeningDetails?.generic?.[key];
  if(!g) return { ok:false, message:"Generic module not found." };

  g.nextDue = null;

  if(g.done !== true) return { ok:false, message:"Not marked as done." };
  if(!g.lastDate) return { ok:false, message:"Missing last date." };

  let years = null;

  if(g.intervalType === "ANNUAL"){
    years = 1;
  } else if(g.intervalType === "ONE_TIME"){
    g.nextDue = null;
    return { ok:true, message:"One-time completed (repeat if risk).", nextDue:null, overdue:false };
  } else if(g.intervalType === "RISK_BASED"){
    // Simple transparent rule:
    // Higher risk -> annual; otherwise default every 3 years
    const highRisk =
      state.risks.dm || state.risks.ckd || state.risks.smoker || state.risks.obesity || state.risks.htn;
    years = highRisk ? 1 : 3;
    g.note = highRisk
      ? "Higher CVD risk: annual BP screening."
      : "If previously normal: every 3–5 years (default 3 years).";
  } else if(g.intervalType === "POLICY"){
    years = g.intervalYears ? Number(g.intervalYears) : null;
  }

  if(!years) return { ok:false, message:"Interval not defined." };

  g.nextDue = addYearsISO(g.lastDate, years);
  const overdue = g.nextDue ? isOnOrBeforeISO(g.nextDue, todayISO()) : false;

  return { ok:true, message: overdue ? "Overdue." : "Up to date.", nextDue:g.nextDue, intervalYears:years, overdue };
}

function syncBucketFromGeneric(key, bucketKey){
  const g = state.screeningDetails?.generic?.[key];
  if(!g) return;

  const calc = calcNextDueGeneric(key);

  if(g.done === true){
    if(calc.ok && calc.nextDue){
      state.screening[bucketKey] = calc.overdue ? "overdue" : "recent";
    } else if(calc.ok && g.intervalType === "ONE_TIME"){
      state.screening[bucketKey] = "recent";
    } else {
      state.screening[bucketKey] = "unknown";
    }
  } else if(g.done === false){
    state.screening[bucketKey] = "never";
  } else {
    state.screening[bucketKey] = "unknown";
  }
}

function renderGenericWizard(key, bucketKey, title, help, intervalMode){
  const g = state.screeningDetails.generic[key];
  g.intervalType = intervalMode;

  calcNextDueGeneric(key);
  syncBucketFromGeneric(key, bucketKey);

  const bucket = state.screening[bucketKey];
  const badge = genericStatusBadge(bucket);

  const nextText =
    (g.done === true && g.intervalType === "ONE_TIME")
      ? "N/A (one-time; repeat if risk)"
      : (g.nextDue || "—");

  const intervalText =
    g.intervalType === "ANNUAL" ? "Interval: 1 year" :
    g.intervalType === "ONE_TIME" ? "Interval: One-time" :
    g.intervalType === "RISK_BASED" ? "Interval: risk-based (auto)" :
    "Interval: —";

  const noteLine = g.note ? `<div class="tiny" style="margin-top:6px">${g.note}</div>` : "";

  return `
    <div class="bucket">
      <div>
        <b>${title}</b><br>
        <small>${help}</small>
      </div>

      <select onchange="
        const v=this.value;
        if(v==='done'){ state.screeningDetails.generic['${key}'].done=true; }
        else if(v==='notdone'){ state.screeningDetails.generic['${key}'].done=false; }
        else { state.screeningDetails.generic['${key}'].done=null; }

        if(state.screeningDetails.generic['${key}'].done!==true){
          state.screeningDetails.generic['${key}'].lastDate=null;
          state.screeningDetails.generic['${key}'].nextDue=null;
        }
        renderScreening();
      ">
        <option value="unknown" ${g.done===null?"selected":""}>Unknown</option>
        <option value="done" ${g.done===true?"selected":""}>Done</option>
        <option value="notdone" ${g.done===false?"selected":""}>Not done</option>
      </select>
    </div>

    ${
      g.done === true ? `
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Date performed (Gregorian)</label>
            <input type="date" value="${g.lastDate ?? ""}"
              onchange="state.screeningDetails.generic['${key}'].lastDate=this.value||null; renderScreening();">
          </div>

          <div class="field">
            <label>Interval</label>
            <input type="text" value="${intervalText}" readonly>
          </div>

          <div class="field">
            <label>Next due (calculated)</label>
            <input type="text" value="${nextText}" readonly>
          </div>
        </div>

        <div class="results">
          <div class="item">
            <div class="top">
              <div><b>${title}</b></div>
              ${badge}
            </div>
            <div class="msg">
              <div><b>Status:</b> ${genericDoneValueToText(g.done)}</div>
              <div><b>Last date:</b> ${g.lastDate ?? "—"}</div>
              <div><b>Next due:</b> ${nextText}</div>
              ${noteLine}
            </div>
          </div>
        </div>
      ` : `
        <div class="results">
          <div class="item">
            <div class="top">
              <div><b>${title}</b></div>
              ${badge}
            </div>
            <div class="msg">
              <div><b>Status:</b> ${genericDoneValueToText(g.done)}</div>
              <div><b>Next due:</b> ${g.done===false ? "Due now" : "—"}</div>
              ${noteLine}
            </div>
          </div>
        </div>
      `
    }
  `;
}

// ---------- CRC labels + engine ----------
function crcMethodLabel(v){
  switch(v){
    case "FIT_FOBT": return "FIT / FOBT — every 1 year";
    case "FIT_DNA": return "Stool DNA (FIT-DNA) — every 3 years";
    case "SIGMOIDOSCOPY": return "Flexible sigmoidoscopy — every 5 years";
    case "CT_COLONOGRAPHY": return "CT colonography — every 5 years";
    case "COLONOSCOPY": return "Colonoscopy — every 10 years (avg risk)";
    default: return "—";
  }
}

function crcIntervalYearsByMethod(method){
  switch(method){
    case "FIT_FOBT": return 1;
    case "FIT_DNA": return 3;
    case "SIGMOIDOSCOPY": return 5;
    case "CT_COLONOGRAPHY": return 5;
    case "COLONOSCOPY": return 10;
    default: return null;
  }
}

function calcCRCStartAgeAndIntervalFromFHx(crc){
  const out = { startAge: 45, intervalYears: null, note: "" };

  if(!crc.fhxFDR){
    out.startAge = 45;
    out.note = "Average risk: start at age 45 (USPSTF age band applies).";
    return out;
  }

  out.startAge = 40;
  const highRisk = (crc.fhxAgeAtDx === "<60") || (crc.fhxNumFDR === "two_or_more");

  if(highRisk){
    out.intervalYears = 5;
    out.note = "Increased-risk FHx: colonoscopy is usually preferred; interval every 5 years.";
  } else {
    out.intervalYears = null; // method-based
    out.note = "FHx present: earlier start (age 40). Interval may follow method/policy.";
  }
  return out;
}

function calcCRCNextDue(){
  const crc = state.screeningDetails.crc;

  crc.startAge = null;
  crc.intervalYears = null;
  crc.nextDue = null;

  const f = calcCRCStartAgeAndIntervalFromFHx(crc);
  crc.startAge = f.startAge;

  if(crc.result === "abnormal"){
    return { ok:false, message:"Abnormal result: routine interval not applicable.", note:f.note };
  }

  let interval = f.intervalYears;
  if(interval === null) interval = crcIntervalYearsByMethod(crc.method);
  crc.intervalYears = interval;

  if(crc.done !== true) return { ok:false, message:"Not marked as done.", note:f.note };
  if(!crc.lastDate || !interval) return { ok:false, message:"Missing last date or method interval.", note:f.note };

  crc.nextDue = addYearsISO(crc.lastDate, interval);
  const overdue = crc.nextDue ? isOnOrBeforeISO(crc.nextDue, todayISO()) : false;

  // Sync bucket
  state.screening.crc = overdue ? "overdue" : "recent";

  return { ok:true, nextDue:crc.nextDue, overdue, note:f.note };
}

function renderCRCWizard(){
  const crc = state.screeningDetails.crc;
  const calc = calcCRCNextDue();

  // if not done/unknown, keep bucket compatible
  if(crc.done === false) state.screening.crc = "never";
  if(crc.done === null) state.screening.crc = "unknown";
  if(crc.done === true && (!crc.lastDate || !crc.method) && crc.result !== "abnormal") state.screening.crc = "unknown";

  const badge = genericStatusBadge(state.screening.crc);

  const fhxText = crc.fhxFDR
    ? `FHx: Yes (FDR; Dx age: ${crc.fhxAgeAtDx}; #FDR: ${crc.fhxNumFDR === "two_or_more" ? "≥2" : "1"})`
    : "FHx: No";

  const highRiskFHx = crc.fhxFDR && (crc.fhxAgeAtDx === "<60" || crc.fhxNumFDR === "two_or_more");
  const stoolBased = (crc.method === "FIT_FOBT" || crc.method === "FIT_DNA");
  const softWarn = (highRiskFHx && stoolBased)
    ? `<div class="note" style="margin-top:10px;border-style:solid;border-color:rgba(255,204,102,.35)">
         Increased-risk FHx selected: stool-based tests are not preferred. Colonoscopy is usually preferred.
       </div>` : "";

  const nextText = (crc.result === "abnormal") ? "N/A (abnormal → follow-up)" : (crc.nextDue || "—");

  return `
    <div class="bucket">
      <div>
        <b>Colorectal cancer screening (CRC)</b><br>
        <small>Wizard: method + last date + family history → next due.</small>
      </div>
      <select onchange="
        const v=this.value;
        if(v==='done'){ state.screeningDetails.crc.done=true; }
        else if(v==='notdone'){ state.screeningDetails.crc.done=false; }
        else { state.screeningDetails.crc.done=null; }

        if(state.screeningDetails.crc.done!==true){
          state.screeningDetails.crc.lastDate=null;
          state.screeningDetails.crc.method='';
          state.screeningDetails.crc.result='unknown';
          state.screeningDetails.crc.nextDue=null;
          state.screeningDetails.crc.intervalYears=null;
        }
        renderScreening();
      ">
        <option value="unknown" ${crc.done===null?"selected":""}>Unknown</option>
        <option value="done" ${crc.done===true?"selected":""}>Done</option>
        <option value="notdone" ${crc.done===false?"selected":""}>Not done</option>
      </select>
    </div>

    <div class="bucket">
      <div>
        <b>Family history (FDR CRC / advanced adenoma)</b><br>
        <small>Changes start age + interval.</small>
      </div>
      <select onchange="
        const v=this.value;
        state.screeningDetails.crc.fhxFDR = (v==='yes');
        if(v!=='yes'){ state.screeningDetails.crc.fhxAgeAtDx='unknown'; state.screeningDetails.crc.fhxNumFDR='one'; }
        renderScreening();
      ">
        <option value="no" ${crc.fhxFDR===false?"selected":""}>No</option>
        <option value="yes" ${crc.fhxFDR===true?"selected":""}>Yes</option>
      </select>
    </div>

    ${
      crc.fhxFDR ? `
        <div class="row" style="margin-top:8px">
          <div class="field">
            <label>FDR age at diagnosis</label>
            <select onchange="state.screeningDetails.crc.fhxAgeAtDx=this.value; renderScreening();">
              <option value="unknown" ${crc.fhxAgeAtDx==="unknown"?"selected":""}>Unknown</option>
              <option value="<60" ${crc.fhxAgeAtDx==="<60"?"selected":""}>&lt; 60 years</option>
              <option value=">=60" ${crc.fhxAgeAtDx===">=60"?"selected":""}>&ge; 60 years</option>
            </select>
          </div>
          <div class="field">
            <label>Number of affected FDRs</label>
            <select onchange="state.screeningDetails.crc.fhxNumFDR=this.value; renderScreening();">
              <option value="one" ${crc.fhxNumFDR==="one"?"selected":""}>One</option>
              <option value="two_or_more" ${crc.fhxNumFDR==="two_or_more"?"selected":""}>Two or more</option>
            </select>
          </div>
        </div>
      ` : ``
    }

    ${
      crc.done===true ? `
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Which test was done?</label>
            <select onchange="state.screeningDetails.crc.method=this.value; renderScreening();">
              <option value="" ${crc.method===""?"selected":""}>—</option>
              <option value="FIT_FOBT" ${crc.method==="FIT_FOBT"?"selected":""}>FIT / FOBT</option>
              <option value="FIT_DNA" ${crc.method==="FIT_DNA"?"selected":""}>Stool DNA (FIT-DNA)</option>
              <option value="SIGMOIDOSCOPY" ${crc.method==="SIGMOIDOSCOPY"?"selected":""}>Flexible sigmoidoscopy</option>
              <option value="CT_COLONOGRAPHY" ${crc.method==="CT_COLONOGRAPHY"?"selected":""}>CT colonography</option>
              <option value="COLONOSCOPY" ${crc.method==="COLONOSCOPY"?"selected":""}>Colonoscopy</option>
            </select>
          </div>

          <div class="field">
            <label>Date performed (Gregorian)</label>
            <input type="date" value="${crc.lastDate ?? ""}"
              onchange="state.screeningDetails.crc.lastDate=this.value||null; renderScreening();">
          </div>

          <div class="field">
            <label>Result (optional)</label>
            <select onchange="state.screeningDetails.crc.result=this.value; renderScreening();">
              <option value="unknown" ${crc.result==="unknown"?"selected":""}>Unknown</option>
              <option value="normal" ${crc.result==="normal"?"selected":""}>Normal</option>
              <option value="abnormal" ${crc.result==="abnormal"?"selected":""}>Abnormal</option>
            </select>
          </div>
        </div>
      ` : ``
    }

    <div class="results">
      <div class="item">
        <div class="top">
          <div><b>CRC summary</b></div>
          ${badge}
        </div>
        <div class="msg">
          <div><b>Status:</b> ${genericDoneValueToText(crc.done)}</div>
          <div><b>Method:</b> ${crc.method ? crcMethodLabel(crc.method) : "—"}</div>
          <div><b>Last date:</b> ${crc.lastDate || "—"}</div>
          <div><b>Next due:</b> ${nextText}</div>
          <div><b>${fhxText}</b></div>
          ${calc && calc.note ? `<div class="tiny" style="margin-top:6px">${calc.note}</div>` : ""}
        </div>
      </div>
    </div>

    ${softWarn}
  `;
}

// ---------- Screening page (REPLACES stub renderScreening) ----------
function renderScreening(){
  const d = state.demographics;

  // Ensure age/BMI current
  if(d.dobGregorian) d.age = calcAgeFromDob(d.dobGregorian);
  d.bmi = calcBMI(d.heightCm, d.weightKg);
  if(d.bmi !== null) state.risks.obesity = (d.bmi >= 30);

  // Build page
  let html = `
    <div class="note">
      Mark items as <b>Done</b> and enter the last date to calculate the <b>next due</b> date.
      This is session-only and does not store patient data.
    </div>
  `;
   // V2 policy banner (session-only)
  html += `
    <div class="note" style="margin-top:12px">
      <b>Policy:</b> ${policyLabel()} &nbsp; 
      <span class="tiny">(session-only selector)</span><br>
      <div class="btns" style="margin-top:10px">
        <div class="btn" onclick="cyclePolicy(); applyPolicyHooks(); renderScreening();">Switch Policy</div>
      </div>
    </div>
  `;
 
  // V2 Pregnancy pathway (only when applicable)
  if (d.sex === "female" && d.pregnant === true) {
    html += renderPregnancyPanel();
  }

  // V2 filter UI (default hides non-eligible)
  html += `
    <div class="row" style="margin-top:10px">
      <div class="field">
        <label>Screening filter</label>
        <select onchange="state.ui.showNonEligible = (this.value==='show'); renderScreening();">
          <option value="hide" ${state.ui.showNonEligible ? "" : "selected"}>Hide non-eligible items</option>
          <option value="show" ${state.ui.showNonEligible ? "selected" : ""}>Show non-eligible items</option>
        </select>
      </div>
      <div class="field">
        <label>Sorting</label>
        <input type="text" value="Due / Overdue first" readonly>
      </div>
    </div>
  `;

  const sections = [];

  // -----------------------
  // Pregnancy panel (not part of sorting list; always near top when applicable)
  // -----------------------
  if (d.sex === "female" && d.pregnant === true) {
    html += renderPregnancyPanel();
  }

  // -----------------------
  // Eligibility helpers
  // -----------------------
  const isFemale = (d.sex === "female");
  const isMale = (d.sex === "male");
  const age = d.age;

  const eligibleHTN = (age !== null && age >= 18);
  const eligibleDM = (age !== null && age >= 35 && age <= 70 && (state.risks.obesity || (d.bmi !== null && d.bmi >= 25)) && !state.risks.dm);
  const eligibleCRC = (age !== null && age >= 45);
  const eligibleHIV = (age !== null && age >= 15);
  const eligibleHCV = (age !== null && age >= 18);
  const eligibleLipids = (age !== null && age >= 20);

  const eligibleCervical = (isFemale && age !== null && age >= 21 && age <= 65);
  const eligibleBreast = (isFemale && age !== null && age >= 40);
  const eligibleOsteo = (isFemale && age !== null && age >= 65);

  const eligibleDepression = (age !== null && age >= 12);
  const eligibleAAA = (isMale && age !== null && age >= 65 && age <= 75 && state.risks.smoker);

  // -----------------------
  // Build sections (only eligible unless showNonEligible enabled)
  // -----------------------

  // HTN
  if (eligibleHTN) {
    const block = renderGenericWizard("htn","htn","Blood pressure screening (HTN)","Adults ≥18 (risk-based frequency).","RISK_BASED");
    pushScreeningSection(sections, "htn", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "htn", renderNotEligibleBlock("Blood pressure screening (HTN)", "Not eligible based on demographics."));
  }

  // DM screening
  if (eligibleDM) {
    const block = renderGenericWizard("dm","dm","Diabetes screening (if not known DM)","35–70 with overweight/obesity (USPSTF framework).","ANNUAL");
    pushScreeningSection(sections, "dm", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "dm", renderNotEligibleBlock("Diabetes screening", "Not eligible (age/risk/known diabetes)."));
  }

  // Depression
  if (eligibleDepression) {
    const block = renderGenericWizard("depression","depression","Depression screening (PHQ-2/PHQ-9)","Annual where systems exist (policy/practice-dependent).","ANNUAL");
    pushScreeningSection(sections, "depression", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "depression", renderNotEligibleBlock("Depression screening", "Not eligible based on age."));
  }

  // AAA
  if (eligibleAAA) {
    const block = renderGenericWizard("aaa","aaa","AAA screening (abdominal ultrasound)","One-time screening in eligible patients (repeat if special risk).","ONE_TIME");
    pushScreeningSection(sections, "aaa", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "aaa", renderNotEligibleBlock("AAA screening (abdominal ultrasound)", "Not eligible (typically male 65–75 ever smoker)."));
  }

  // CRC
  if (eligibleCRC) {
    if(state.risks.fhxCrc && state.screeningDetails.crc.fhxFDR === false){
      state.screeningDetails.crc.fhxFDR = true;
    }
    const block = renderCRCWizard();
    pushScreeningSection(sections, "crc", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "crc", renderNotEligibleBlock("Colorectal cancer screening (CRC)", "Not eligible based on age."));
  }

  // HIV / HCV
  if (eligibleHIV) {
    const block = renderGenericWizard("hiv","hiv","HIV screening","One-time screening (repeat if ongoing risk).","ONE_TIME");
    pushScreeningSection(sections, "hiv", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "hiv", renderNotEligibleBlock("HIV screening", "Not eligible based on age."));
  }

  if (eligibleHCV) {
    const block = renderGenericWizard("hcv","hcv","Hepatitis C screening","One-time screening for adults (repeat if risk).","ONE_TIME");
    pushScreeningSection(sections, "hcv", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "hcv", renderNotEligibleBlock("Hepatitis C screening", "Not eligible based on age."));
  }

  // Lipids
  if (eligibleLipids) {
    const block = renderLipidsWizard();
    pushScreeningSection(sections, "lipids", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "lipids", renderNotEligibleBlock("Lipid panel / ASCVD risk assessment", "Not eligible based on age."));
  }

  // Cervical
  if (eligibleCervical) {
    const block = renderCervicalWizard();
    pushScreeningSection(sections, "cervical", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "cervical", renderNotEligibleBlock("Cervical cancer screening", "Not eligible (female 21–65)."));
  }

  // Breast
  if (eligibleBreast) {
    const block = renderBreastWizard();
    pushScreeningSection(sections, "breast", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "breast", renderNotEligibleBlock("Breast cancer screening (mammography)", "Not eligible based on demographics/age."));
  }

  // Osteoporosis
  if (eligibleOsteo) {
    const block = renderOsteoporosisWizard();
    pushScreeningSection(sections, "osteoporosis", block);
  } else if (state.ui.showNonEligible) {
    pushScreeningSection(sections, "osteoporosis", renderNotEligibleBlock("Osteoporosis screening (DXA)", "Not eligible (commonly female ≥65)."));
  }

  // -----------------------
  // Sort by bucket priority (Due first) then original order
  // -----------------------
  sections.sort((a,b)=> (a.pr - b.pr) || (a.order - b.order));

  // Append sorted blocks
  html += sections.map(x=>x.html).join("");


  html += `
    <div class="btns">
      <div class="btn" onclick="go('risks')">Back</div>
      <div class="btn primary" onclick="go('results')">Generate Results</div>
      <div class="btn" onclick="go('export')">Export</div>
    </div>
  `;

  $("leftPane").innerHTML = html;
  setStatus("ok","Screening");
}
/* =========================================================
   SCREENING WIZARDS (BLOCK 4B)
   - HIV, HCV (one-time)
   - Lipids (policy interval selection)
   ========================================================= */

function lipidsIntervalLabel(v){
  switch(v){
    case "1": return "Every 1 year";
    case "3": return "Every 3 years";
    case "5": return "Every 5 years";
    case "10": return "Every 10 years";
    default: return "—";
  }
}

function renderLipidsWizard(){
  const g = state.screeningDetails.generic.lipids;
  g.intervalType = "POLICY";
// V2 suggestion: apply only if interval not yet selected
if (g.intervalYears === null && g.done === true) {
  g.intervalYears = suggestLipidsIntervalYears();
}

  // calculate + sync
  calcNextDueGeneric("lipids");
  syncBucketFromGeneric("lipids", "lipids");

  const bucket = state.screening.lipids;
  const badge = genericStatusBadge(bucket);

  const nextText = g.nextDue || "—";
  const intervalText = g.intervalYears ? lipidsIntervalLabel(String(g.intervalYears)) : "—";

  return `
    <div class="bucket">
      <div>
        <b>Lipid panel / ASCVD risk assessment</b><br>
        <small>Select your clinic interval (policy-based) to calculate next due.</small>
      </div>

      <select onchange="
        const v=this.value;
        if(v==='done'){ state.screeningDetails.generic.lipids.done=true; }
        else if(v==='notdone'){ state.screeningDetails.generic.lipids.done=false; }
        else { state.screeningDetails.generic.lipids.done=null; }

        if(state.screeningDetails.generic.lipids.done!==true){
          state.screeningDetails.generic.lipids.lastDate=null;
          state.screeningDetails.generic.lipids.intervalYears=null;
          state.screeningDetails.generic.lipids.nextDue=null;
        }
        renderScreening();
      ">
        <option value="unknown" ${g.done===null ? "selected" : ""}>Unknown</option>
        <option value="done" ${g.done===true ? "selected" : ""}>Done</option>
        <option value="notdone" ${g.done===false ? "selected" : ""}>Not done</option>
      </select>
    </div>

    ${
      g.done === true ? `
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Date performed (Gregorian)</label>
            <input type="date" value="${g.lastDate ?? ""}"
              onchange="state.screeningDetails.generic.lipids.lastDate=this.value||null; renderScreening();">
          </div>

          <div class="field">
            <label>Policy interval</label>
            <select onchange="
              const n=this.value?Number(this.value):null;
              state.screeningDetails.generic.lipids.intervalYears=n;
              renderScreening();
            ">
              <option value="" ${g.intervalYears===null ? "selected" : ""}>— select —</option>
              <option value="1" ${g.intervalYears===1 ? "selected" : ""}>Every 1 year</option>
              <option value="3" ${g.intervalYears===3 ? "selected" : ""}>Every 3 years</option>
              <option value="5" ${g.intervalYears===5 ? "selected" : ""}>Every 5 years</option>
              <option value="10" ${g.intervalYears===10 ? "selected" : ""}>Every 10 years</option>
            </select>
          </div>

          <div class="field">
            <label>Next due (calculated)</label>
            <input type="text" value="${nextText}" readonly>
          </div>
        </div>

        <div class="results">
          <div class="item">
            <div class="top">
              <div><b>Lipids summary</b></div>
              ${badge}
            </div>
            <div class="msg">
              <div><b>Status:</b> ${genericDoneValueToText(g.done)}</div>
              <div><b>Last date:</b> ${g.lastDate ?? "—"}</div>
              <div><b>Interval:</b> ${intervalText}</div>
              <div><b>Next due:</b> ${nextText}</div>
			  <div class="tiny" style="margin-top:6px">Suggested interval based on risk factors (editable).</div>

              <div class="tiny" style="margin-top:6px">
                Interval varies by local protocol/risk. This is a policy selector.
              </div>
            </div>
          </div>
        </div>
      ` : `
        <div class="results">
          <div class="item">
            <div class="top">
              <div><b>Lipids summary</b></div>
              ${badge}
            </div>
            <div class="msg">
              <div><b>Status:</b> ${genericDoneValueToText(g.done)}</div>
              <div><b>Next due:</b> ${g.done===false ? "Due now" : "—"}</div>
              <div class="tiny" style="margin-top:6px">
                Select “Done” to enter last date and policy interval.
              </div>
            </div>
          </div>
        </div>
      `
    }
  `;
}

/* =========================================================
   CERVICAL WIZARD (BLOCK 6A)
   - Pap / HPV / Co-test (method-based intervals)
   ========================================================= */

function cervicalMethodLabel(v){
  switch(v){
    case "PAP": return "Cytology (Pap) — every 3 years (21–29; option 30–65)";
    case "HPV": return "Primary hrHPV — every 5 years (30–65)";
    case "COTEST": return "Co-test (Pap + hrHPV) — every 5 years (30–65)";
    default: return "—";
  }
}

function cervicalIntervalByAgeAndMethod(age, method){
  // Simplified USPSTF framework:
  // 21–29: Pap q3y
  // 30–65: Pap q3y OR primary HPV q5y OR co-test q5y
  if(age === null) return { years:null, note:"Age missing." };

  if(age < 21){
    return { years:null, note:"Not routinely recommended <21." };
  }
  if(age >= 21 && age <= 29){
    if(method === "PAP") return { years:3, note:"21–29: cytology every 3 years." };
    return { years:null, note:"21–29: use Pap (cytology) q3y (HPV/co-test not routine)." };
  }
  if(age >= 30 && age <= 65){
    if(method === "PAP") return { years:3, note:"30–65: cytology every 3 years is acceptable." };
    if(method === "HPV") return { years:5, note:"30–65: primary hrHPV every 5 years is acceptable." };
    if(method === "COTEST") return { years:5, note:"30–65: co-testing every 5 years is acceptable." };
    return { years:null, note:"Select method to calculate interval." };
  }
  // >65 handled in Results later; here just keep as policy/consider
  return { years:null, note:"Age >65: depends on prior screening adequacy and risk." };
}

function calcNextDueCervical(){
  const g = state.screeningDetails.generic.cervical;
  g.nextDue = null;
  g.intervalYears = null;

  if(g.done !== true) return { ok:false, message:"Not marked as done." };
  if(!g.lastDate) return { ok:false, message:"Missing last date." };

  const age = state.demographics.age;
  const method = g.method || "";
  const info = cervicalIntervalByAgeAndMethod(age, method);

  g.intervalYears = info.years;
  g.note = info.note;

  if(!info.years){
    return { ok:false, message:"Interval not defined.", note: info.note };
  }

  g.nextDue = addYearsISO(g.lastDate, info.years);
  const overdue = g.nextDue ? isOnOrBeforeISO(g.nextDue, todayISO()) : false;

  // Sync legacy bucket
  state.screening.cervical = overdue ? "overdue" : "recent";
  return { ok:true, nextDue:g.nextDue, overdue, note:info.note };
}

function renderCervicalWizard(){
  const g = state.screeningDetails.generic.cervical;

  // Calculate + sync (safe)
  const calc = (g.done === true) ? calcNextDueCervical() : null;
  if(g.done === false) state.screening.cervical = "never";
  if(g.done === null) state.screening.cervical = "unknown";
  if(g.done === true && (!g.lastDate || !g.method)) state.screening.cervical = "unknown";

  const badge = genericStatusBadge(state.screening.cervical);
  const nextText = g.nextDue || "—";

  return `
    <div class="bucket">
      <div>
        <b>Cervical cancer screening</b><br>
        <small>Wizard: method + last date → next due (USPSTF framework).</small>
      </div>

      <select onchange="
        const v=this.value;
        if(v==='done'){ state.screeningDetails.generic.cervical.done=true; }
        else if(v==='notdone'){ state.screeningDetails.generic.cervical.done=false; }
        else { state.screeningDetails.generic.cervical.done=null; }

        if(state.screeningDetails.generic.cervical.done!==true){
          state.screeningDetails.generic.cervical.lastDate=null;
          state.screeningDetails.generic.cervical.method='';
          state.screeningDetails.generic.cervical.intervalYears=null;
          state.screeningDetails.generic.cervical.nextDue=null;
          state.screeningDetails.generic.cervical.note='';
        }
        renderScreening();
      ">
        <option value="unknown" ${g.done===null?"selected":""}>Unknown</option>
        <option value="done" ${g.done===true?"selected":""}>Done</option>
        <option value="notdone" ${g.done===false?"selected":""}>Not done</option>
      </select>
    </div>

    ${
      g.done === true ? `
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Method</label>
            <select onchange="state.screeningDetails.generic.cervical.method=this.value; renderScreening();">
              <option value="" ${g.method===""?"selected":""}>—</option>
              <option value="PAP" ${g.method==="PAP"?"selected":""}>Pap (cytology)</option>
              <option value="HPV" ${g.method==="HPV"?"selected":""}>Primary hrHPV</option>
              <option value="COTEST" ${g.method==="COTEST"?"selected":""}>Co-test (Pap + hrHPV)</option>
            </select>
          </div>

          <div class="field">
            <label>Date performed (Gregorian)</label>
            <input type="date" value="${g.lastDate ?? ""}"
              onchange="state.screeningDetails.generic.cervical.lastDate=this.value||null; renderScreening();">
          </div>

          <div class="field">
            <label>Next due (calculated)</label>
            <input type="text" value="${nextText}" readonly>
          </div>
        </div>
      ` : ``
    }

    <div class="results">
      <div class="item">
        <div class="top">
          <div><b>Cervical screening summary</b></div>
          ${badge}
        </div>
        <div class="msg">
          <div><b>Status:</b> ${genericDoneValueToText(g.done)}</div>
          <div><b>Method:</b> ${g.method ? cervicalMethodLabel(g.method) : "—"}</div>
          <div><b>Last date:</b> ${g.lastDate || "—"}</div>
          <div><b>Next due:</b> ${nextText}</div>
          ${g.note ? `<div class="tiny" style="margin-top:6px">${g.note}</div>` : ""}
        </div>
      </div>
    </div>
  `;
}
/* =========================================================
   BREAST + OSTEOPOROSIS WIZARDS (BLOCK 6B)
   - Policy-based intervals (select)
   ========================================================= */

function policyIntervalLabel(v){
  switch(v){
    case "1": return "Every 1 year";
    case "2": return "Every 2 years";
    case "3": return "Every 3 years";
    case "5": return "Every 5 years";
    case "10": return "Every 10 years";
    default: return "—";
  }
}

function calcNextDuePolicy(key, bucketKey){
  const g = state.screeningDetails?.generic?.[key];
  if(!g) return { ok:false, message:"Module not found." };

  g.nextDue = null;

  if(g.done !== true) return { ok:false, message:"Not marked as done." };
  if(!g.lastDate) return { ok:false, message:"Missing last date." };
  if(!g.intervalYears) return { ok:false, message:"Missing interval." };

  const years = Number(g.intervalYears);
  g.nextDue = addYearsISO(g.lastDate, years);
  const overdue = g.nextDue ? isOnOrBeforeISO(g.nextDue, todayISO()) : false;

  state.screening[bucketKey] = overdue ? "overdue" : "recent";
  return { ok:true, nextDue:g.nextDue, overdue };
}

function renderPolicyWizard(key, bucketKey, title, help, intervals){
  // intervals: array of numbers (years) e.g. [1,2,3,5]
  const g = state.screeningDetails.generic[key];
  g.intervalType = "POLICY";

  // calc + sync
  const calc = (g.done === true) ? calcNextDuePolicy(key, bucketKey) : null;
  if(g.done === false) state.screening[bucketKey] = "never";
  if(g.done === null) state.screening[bucketKey] = "unknown";
  if(g.done === true && (!g.lastDate || !g.intervalYears)) state.screening[bucketKey] = "unknown";

  const badge = genericStatusBadge(state.screening[bucketKey]);
  const nextText = g.nextDue || "—";

  const options = intervals.map(y=>{
    const ys = String(y);
    return `<option value="${ys}" ${g.intervalYears===y?"selected":""}>${policyIntervalLabel(ys)}</option>`;
  }).join("");

  return `
    <div class="bucket">
      <div>
        <b>${title}</b><br>
        <small>${help}</small>
      </div>

      <select onchange="
        const v=this.value;
        if(v==='done'){ state.screeningDetails.generic['${key}'].done=true; }
        else if(v==='notdone'){ state.screeningDetails.generic['${key}'].done=false; }
        else { state.screeningDetails.generic['${key}'].done=null; }

        if(state.screeningDetails.generic['${key}'].done!==true){
          state.screeningDetails.generic['${key}'].lastDate=null;
          state.screeningDetails.generic['${key}'].intervalYears=null;
          state.screeningDetails.generic['${key}'].nextDue=null;
        }
        renderScreening();
      ">
        <option value="unknown" ${g.done===null?"selected":""}>Unknown</option>
        <option value="done" ${g.done===true?"selected":""}>Done</option>
        <option value="notdone" ${g.done===false?"selected":""}>Not done</option>
      </select>
    </div>

    ${
      g.done === true ? `
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Date performed (Gregorian)</label>
            <input type="date" value="${g.lastDate ?? ""}"
              onchange="state.screeningDetails.generic['${key}'].lastDate=this.value||null; renderScreening();">
          </div>

          <div class="field">
            <label>Policy interval</label>
            <select onchange="
              const n=this.value?Number(this.value):null;
              state.screeningDetails.generic['${key}'].intervalYears=n;
              renderScreening();
            ">
              <option value="" ${g.intervalYears===null?"selected":""}>— select —</option>
              ${options}
            </select>
          </div>

          <div class="field">
            <label>Next due (calculated)</label>
            <input type="text" value="${nextText}" readonly>
          </div>
        </div>
      ` : ``
    }

    <div class="results">
      <div class="item">
        <div class="top">
          <div><b>${title} summary</b></div>
          ${badge}
        </div>
        <div class="msg">
          <div><b>Status:</b> ${genericDoneValueToText(g.done)}</div>
          <div><b>Last date:</b> ${g.lastDate || "—"}</div>
          <div><b>Interval:</b> ${g.intervalYears ? policyIntervalLabel(String(g.intervalYears)) : "—"}</div>
          <div><b>Next due:</b> ${nextText}</div>
          ${g.note ? `<div class="tiny" style="margin-top:6px">${g.note}</div>` : ""}
        </div>
      </div>
    </div>
  `;
}

function renderBreastWizard(){
  // Common: 1–2 years (and optional 3y in some policies)
  return renderPolicyWizard(
    "breast",
    "breast",
    "Breast cancer screening (mammography)",
    "Policy-based (commonly every 1–2 years depending on age/risk/policy).",
    [1,2,3]
  );
}

function renderOsteoporosisWizard(){
  // DXA often 2–5 years depending on baseline/risk
  return renderPolicyWizard(
    "osteoporosis",
    "osteoporosis",
    "Osteoporosis screening (DXA)",
    "Policy-based (DXA interval per risk and baseline findings).",
    [2,3,5,10]
  );
}



/* =========================================================
   RESULTS ENGINE + RESULTS PAGE (BLOCK 5A)
   ========================================================= */

function addRec(level, title, message, source){
  state.results.push({ level, title, message, source });
}

function evaluateAll(){
  state.results = [];

  const d = state.demographics;
  const r = state.risks;
  const s = state.screening;

  // keep derived obesity up to date
  if(d.bmi !== null) r.obesity = (d.bmi >= 30);

  // Ensure wizard buckets are synced (safe)
  syncBucketFromGeneric("htn","htn");
  syncBucketFromGeneric("dm","dm");
  syncBucketFromGeneric("hiv","hiv");
  syncBucketFromGeneric("hcv","hcv");
  syncBucketFromGeneric("lipids","lipids");
  syncBucketFromGeneric("depression","depression");
  syncBucketFromGeneric("aaa","aaa");

  // CRC bucket handled in calcCRCNextDue(); call it once
  calcCRCNextDue();

  const age = d.age;

  // -------- HTN screening (basic framework) --------
  if(age !== null && age >= 18){
    if(s.htn === "recent"){
      addRec("OK","Blood pressure screening","Up to date (based on entered last date/interval).","USPSTF / Primary Care practice");
    } else if(s.htn === "overdue" || s.htn === "never"){
      addRec("DUE","Blood pressure screening","Due based on risk-based interval. Enter last date if done to calculate next due.","USPSTF / Primary Care practice");
    } else {
      addRec("CONSIDER","Blood pressure screening","Consider verifying last BP screening date and interval.","USPSTF / Primary Care practice");
    }
  }

  // -------- Diabetes screening (USPSTF framework) --------
  const eligibleDM = (age !== null && age >= 35 && age <= 70 && (r.obesity || (d.bmi !== null && d.bmi >= 25)));
  if(eligibleDM && !r.dm){
    if(s.dm === "recent"){
      addRec("OK","Diabetes screening","Up to date (based on entered last date/interval).","USPSTF: Prediabetes & Type 2 DM Screening");
    } else if(s.dm === "overdue" || s.dm === "never"){
      addRec("DUE","Diabetes screening","Due: screening indicated in eligible adults. Enter last date if done to calculate next due.","USPSTF: Prediabetes & Type 2 DM Screening");
    } else {
      addRec("CONSIDER","Diabetes screening","Consider screening if not done recently; enter last date if available.","USPSTF: Prediabetes & Type 2 DM Screening");
    }
  } else if(r.dm){
    addRec("OK","Diabetes screening","Known diabetes: screening item not applicable (manage per DM follow-up).","Clinical practice");
  }

  // -------- HIV (one-time) --------
  if(age !== null && age >= 15){
    if(s.hiv === "recent"){
      addRec("OK","HIV screening","Completed (one-time). Repeat if ongoing risk.","CDC / USPSTF");
    } else if(s.hiv === "never" || s.hiv === "overdue"){
      addRec("DUE","HIV screening","Offer at least one-time screening. Repeat if ongoing risk.","CDC / USPSTF");
    } else {
      addRec("CONSIDER","HIV screening","Verify history of prior HIV screening; offer if not previously done.","CDC / USPSTF");
    }
  }

  // -------- HCV (one-time) --------
  if(age !== null && age >= 18){
    if(s.hcv === "recent"){
      addRec("OK","Hepatitis C screening","Completed (one-time). Repeat if ongoing risk.","CDC / USPSTF");
    } else if(s.hcv === "never" || s.hcv === "overdue"){
      addRec("DUE","Hepatitis C screening","Offer one-time screening in eligible adults. Repeat if ongoing risk.","CDC / USPSTF");
    } else {
      addRec("CONSIDER","Hepatitis C screening","Verify history of prior HCV screening; offer if not previously done.","CDC / USPSTF");
    }
  }

  // -------- Lipids (policy-based) --------
  if(age !== null && age >= 20){
    if(s.lipids === "recent"){
      addRec("OK","Lipid panel / ASCVD risk","Up to date (based on selected policy interval).","Clinical practice / local policy");
    } else if(s.lipids === "overdue" || s.lipids === "never"){
      addRec("DUE","Lipid panel / ASCVD risk","Due/consider per local policy and risk profile. Select interval + last date if done.","Clinical practice / local policy");
    } else {
      addRec("CONSIDER","Lipid panel / ASCVD risk","Consider lipid assessment based on age/risk and local protocol.","Clinical practice / local policy");
    }
  }
  // -------- Depression (annual) --------
  if(age !== null && age >= 12){
    if(s.depression === "recent"){
      addRec("OK","Depression screening","Up to date (annual interval based on entered last date).","Clinical practice / USPSTF-related practice");
    } else if(s.depression === "overdue" || s.depression === "never"){
      addRec("DUE","Depression screening","Due: consider PHQ-2/PHQ-9 screening where systems exist.","Clinical practice / USPSTF-related practice");
    } else {
      addRec("CONSIDER","Depression screening","Consider screening based on practice workflow.","Clinical practice / USPSTF-related practice");
    }
  }

  // -------- AAA (one-time) --------
  const eligibleAAA = (d.sex === "male" && age !== null && age >= 65 && age <= 75 && r.smoker);
  if(eligibleAAA){
    if(s.aaa === "recent"){
      addRec("OK","AAA screening (abdominal ultrasound)","Completed (one-time).","USPSTF: AAA Screening");
    } else if(s.aaa === "never" || s.aaa === "overdue"){
      addRec("DUE","AAA screening (abdominal ultrasound)","Offer one-time screening in eligible patients.","USPSTF: AAA Screening");
    } else {
      addRec("CONSIDER","AAA screening (abdominal ultrasound)","Verify if one-time screening was previously done.","USPSTF: AAA Screening");
    }
  }

  // -------- CRC (45–75 routine; 76–85 selective) --------
  const crc = state.screeningDetails.crc;
  if(age !== null){
    if(age >= 45 && age <= 75){
      if(crc.result === "abnormal"){
        addRec("CONSIDER","Colorectal cancer screening (CRC)","Abnormal CRC screening reported → routine interval not applicable; follow-up depends on findings.","USPSTF: Colorectal Cancer Screening");
      } else if(s.crc === "recent"){
        addRec("OK","Colorectal cancer screening (CRC)",
          `Up to date. Last: ${crc.lastDate || "—"}. Method: ${crc.method ? crcMethodLabel(crc.method) : "—"}. Next due: ${crc.nextDue || "—"}.`,
          "USPSTF: Colorectal Cancer Screening"
        );
      } else if(s.crc === "overdue" || s.crc === "never"){
        const fhx = crc.fhxFDR ? ` FHx positive (FDR; Dx age ${crc.fhxAgeAtDx}; #FDR ${crc.fhxNumFDR==="two_or_more"?"≥2":"1"}).` : " FHx negative.";
        addRec("DUE","Colorectal cancer screening (CRC)",
          (crc.done===true
            ? `Overdue based on last date + interval. Last: ${crc.lastDate || "—"}. Method: ${crc.method ? crcMethodLabel(crc.method) : "—"}. Next due: ${crc.nextDue || "—"}.` + fhx
            : `Due: CRC screening indicated.` + fhx),
          "USPSTF: Colorectal Cancer Screening"
        );
      } else {
        addRec("CONSIDER","Colorectal cancer screening (CRC)","Enter method + last date (if done) to calculate next due; consider FHx impact on interval.","USPSTF: Colorectal Cancer Screening");
      }
    } else if(age >= 76 && age <= 85){
      addRec("CONSIDER","Colorectal cancer screening (CRC)","Selective screening: consider overall health, prior screening history, and patient preferences.","USPSTF: Colorectal Cancer Screening");
    }
  }

  // Status pill
  const dueCount = state.results.filter(x=>x.level==="DUE").length;
  const hiCount = state.results.filter(x=>x.level==="CONSIDER").length;
  if(dueCount > 0) setStatus("due", `${dueCount} Due`);
  else if(hiCount > 0) setStatus("hi", `${hiCount} Consider`);
  else setStatus("ok","All OK");
}

function renderResults(){
  evaluateAll();
  // V2 flags + counts
  computeFlagsAndCounts();
  const c = countDueConsiderOk();
  const m = countModuleDue();

  const flagsHtml = state.flags.length
    ? state.flags.map(f=>`
        <div class="item">
          <div class="top">
            <div><b>${f.title}</b></div>
            <span class="badge high">FLAG</span>
          </div>
          <div class="msg">${f.detail}</div>
        </div>
      `).join("")
    : `<div class="note">No flags detected.</div>`;

  const dashboardHtml = `
    <div class="note">
      <b>Dashboard (session-only)</b><br>
      DUE: <b>${c.due}</b> &nbsp; | &nbsp; CONSIDER: <b>${c.consider}</b> &nbsp; | &nbsp; OK: <b>${c.ok}</b><br>
      Screening due: <b>${m.screeningDue}</b> &nbsp; | &nbsp; Vaccinations due: <b>${m.vaxDue}</b> &nbsp; | &nbsp; Pregnancy due: <b>${m.pregDue}</b>
    </div>

    <div class="note" style="margin-top:10px">
      <b>Data quality flags</b><br>
      Fix missing dates/methods to improve accuracy.
    </div>

    <div class="results" style="margin-top:12px">
      ${flagsHtml}
    </div>

    <div class="note" style="margin-top:12px">
      <b>Clinical results</b>
    </div>
  `;
  // V2 prepend dashboard + flags
  // (Clinical result blocks will be appended after)

  const blocks = state.results.map(x=>{
    const cls = x.level === "OK" ? "ok" : x.level === "DUE" ? "due" : "high";
    const title = x.title;
    const msg = x.message || "";
    const src = x.source ? `<div class="src"><b>Source:</b> ${x.source}</div>` : "";
    const badge = `<span class="badge ${cls}">${x.level}</span>`;

    return `
      <div class="item">
        <div class="top">
          <div><b>${title}</b></div>
          ${badge}
        </div>
        <div class="msg">${msg}</div>
        ${src}
      </div>
    `;
  }).join("");

  $("leftPane").innerHTML = `
      ${dashboardHtml}


    <div class="results" style="margin-top:12px">
      ${blocks || `<div class="note">No results yet. Go to Screening and enter data.</div>`}
    </div>

    <div class="btns">
      <div class="btn" onclick="go('screening')">Back to Screening</div>
      <div class="btn primary" onclick="go('export')">Go to Export</div>
    </div>
  `;
}
/* =========================================================
   EXPORT PAGE + NOTE BUILDER (BLOCK 5B)
   ========================================================= */

function copyToClipboard(text){
  if(!text) return;
  navigator.clipboard.writeText(text).then(()=>{
    setStatus("ok","Copied");
  }).catch(()=>{
    // fallback
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      setStatus("ok","Copied");
    }catch(e){
      setStatus("hi","Copy failed");
    }
  });
}

function buildExportText(){
  evaluateAll();

  const d = state.demographics;
  const r = state.risks;

  // -----------------------------
  // Helper: build clinician note
  // -----------------------------
  function buildProgressNote(){
    const lines = [];
    lines.push("PREVENTION & SCREENING SUMMARY (Session-only)");
    lines.push(`Policy: ${policyLabel()}`);
    lines.push("");

    lines.push("DEMOGRAPHICS");
    lines.push(`- Sex: ${d.sex}`);
    lines.push(`- Age: ${d.age ?? "—"}`);
    lines.push(`- BMI: ${d.bmi ?? "—"}`);
    if(d.sex === "female"){
      lines.push(`- Pregnant: ${d.pregnant ? "Yes" : "No"}`);
      if(d.pregnant){
        lines.push(`- LMP: ${d.lmp || "—"}`);
      }
    }
    lines.push("");

    lines.push("RISK FACTORS (selected)");
    const rf = [];
    if(r.smoker) rf.push("Smoker");
    if(r.obesity) rf.push("Obesity");
    if(r.htn) rf.push("Known HTN");
    if(r.dm) rf.push("Known DM");
    if(r.dyslipidemia) rf.push("Dyslipidemia");
    if(r.ckd) rf.push("CKD");
    if(r.fhxPrematureCvd) rf.push("FHx premature CVD");
    if(r.fhxCrc) rf.push("FHx CRC");
    lines.push(`- ${rf.length ? rf.join(", ") : "None recorded"}`);
    lines.push("");

    const due = state.results.filter(x=>x.level==="DUE");
    const consider = state.results.filter(x=>x.level==="CONSIDER");
    const ok = state.results.filter(x=>x.level==="OK");

    function listGroup(title, arr){
      lines.push(title);
      if(!arr.length){
        lines.push("- None");
        lines.push("");
        return;
      }
      arr.forEach(x=>{
        lines.push(`- ${x.title}: ${x.message}`);
      });
      lines.push("");
    }

    listGroup("DUE ITEMS", due);
    listGroup("CONSIDER ITEMS", consider);
    listGroup("UP TO DATE", ok);

    // Key screening dates (from wizards)
    lines.push("KEY DATES (if entered)");
    const g = state.screeningDetails.generic;

    function addKey(label, obj){
      if(!obj || obj.done !== true) return;

      // For generic types, nextDue may already be computed by wizards
      const next =
        (obj.intervalType === "ONE_TIME") ? "N/A (one-time; repeat if risk)" :
        (obj.nextDue || "—");

      const interval =
        (obj.intervalType === "POLICY" && obj.intervalYears) ? `${obj.intervalYears}y` :
        (obj.intervalType === "ANNUAL") ? "1y" :
        (obj.intervalType === "RISK_BASED") ? "risk-based" :
        (obj.intervalType === "BY_METHOD") ? "by method" :
        (obj.intervalType === "ONE_TIME") ? "one-time" :
        "—";

      lines.push(`- ${label}: Last=${obj.lastDate ?? "—"}; Interval=${interval}; Next=${next}.`);
    }

    addKey("Blood pressure screening", g.htn);
    addKey("Diabetes screening", g.dm);
    addKey("Lipid panel / ASCVD risk", g.lipids);
    addKey("HIV screening", g.hiv);
    addKey("Hepatitis C screening", g.hcv);
    addKey("Cervical cancer screening", g.cervical);
    addKey("Breast cancer screening (mammography)", g.breast);
    addKey("Osteoporosis screening (DXA)", g.osteoporosis);
    addKey("Depression screening", g.depression);
    addKey("AAA screening (abdominal ultrasound)", g.aaa);

    // CRC detail block
    const crc = state.screeningDetails.crc;
    lines.push("");
    lines.push("COLORECTAL CANCER (CRC) — DETAILS");
    const crcStatus = crc.done===true ? "Done" : crc.done===false ? "Not done" : "Unknown";
    lines.push(`- Status: ${crcStatus}`);
    const fhxText = crc.fhxFDR
      ? `Yes (FDR; Dx age: ${crc.fhxAgeAtDx}; #FDR: ${crc.fhxNumFDR==="two_or_more"?"≥2":"1"})`
      : "No";
    lines.push(`- Family history (FDR CRC/advanced adenoma): ${fhxText}`);
    if(crc.done===true){
      lines.push(`- Method: ${crc.method ? crcMethodLabel(crc.method) : "—"}`);
      lines.push(`- Last performed: ${crc.lastDate ?? "—"}`);
      if(crc.result && crc.result !== "unknown"){
        lines.push(`- Reported result: ${crc.result.toUpperCase()}`);
      }
      if(crc.result === "abnormal"){
        lines.push("- Next due: Not applicable (abnormal result → follow-up based on findings).");
      } else {
        lines.push(`- Next due (calculated): ${crc.nextDue ?? "—"}`);
      }
    }

    // Pregnancy export (if applicable and available)
    if(d.sex === "female" && d.pregnant === true){
      const ga = (typeof getGAWeeksFromState === "function") ? getGAWeeksFromState() : null;
      const edd = (typeof getEDDFromLMP === "function") ? getEDDFromLMP() : null;
      lines.push("");
      lines.push("PREGNANCY PATHWAY (GA-based, session-only)");
      lines.push(`- GA (weeks): ${ga ?? "—"}`);
      lines.push(`- EDD (from LMP): ${edd ?? "—"}`);

      if(state.pregnancy && state.pregnancy.items){
        const it = state.pregnancy.items;
        Object.keys(it).forEach(k=>{
          const item = it[k];
          const status = item.done===true ? "Done" : item.done===false ? "Not done" : "Unknown";
          lines.push(`- ${k}: ${status}; Date=${item.date ?? "—"}`);
        });
      }
      lines.push("");
    }

    // Vaccinations export (if module exists)
    if(state.vaccinations){
      lines.push("");
      lines.push("VACCINATIONS (session-only)");
      Object.keys(state.vaccinations).forEach(k=>{
        const v = state.vaccinations[k];
        const status = v.done===true ? "Done" : v.done===false ? "Not done" : "Unknown";
        const next =
          (v.done===true && v.intervalType==="ONE_TIME") ? "N/A" :
          (v.nextDue || "—");
        lines.push(`- ${k}: ${status}; Last=${v.lastDate ?? "—"}; Next=${next}`);
      });
      lines.push("");
    }

    lines.push("programed by Dr. Abdullah Hosni Alreedy");
    return lines.join("\n");
  }

  // -----------------------------
  // Helper: build patient summary
  // -----------------------------
  function buildPatientSummary(){
    const lines = [];
    lines.push("PREVENTION SUMMARY (Session-only)");
    lines.push(`Policy: ${policyLabel()}`);
    lines.push("");

    lines.push(`Age: ${d.age ?? "—"} | Sex: ${d.sex} | BMI: ${d.bmi ?? "—"}`);
    if(d.sex === "female" && d.pregnant){
      lines.push(`Pregnancy: Yes | LMP: ${d.lmp || "—"}`);
    }
    lines.push("");

    const due = state.results.filter(x=>x.level==="DUE");
    const consider = state.results.filter(x=>x.level==="CONSIDER");

    lines.push("WHAT YOU NEED NOW");
    if(!due.length) lines.push("- No urgent due items found based on entered data.");
    else due.forEach(x=> lines.push(`- ${x.title}`));
    lines.push("");

    lines.push("THINGS TO DISCUSS");
    if(!consider.length) lines.push("- None listed.");
    else consider.forEach(x=> lines.push(`- ${x.title}`));
    lines.push("");

    lines.push("Session-only. No data is stored.");
    return lines.join("\n");
  }

  // Select output
  state.exportText = (state.ui.exportMode === "patient")
    ? buildPatientSummary()
    : buildProgressNote();
}


function renderExport(){
  buildExportText();

  $("leftPane").innerHTML = `
    <div class="note">
      Copy the text below and paste it into your progress note.
    </div>

    <div class="btns">
      <div class="btn" onclick="go('results')">Back to Results</div>
      <div class="btn primary" onclick="copyToClipboard(state.exportText)">Copy</div>

      <div class="btn" onclick="
        state.ui.exportMode = (state.ui.exportMode==='progress') ? 'patient' : 'progress';
        renderExport();
      ">Mode: ${state.ui.exportMode === "patient" ? "Patient Summary" : "Progress Note"}</div>

      <div class="btn danger" onclick="
        // Reset session (no storage)
        state.demographics = { sex:'male', dobGregorian:'', age:null, heightCm:'', weightKg:'', bmi:null, pregnant:false, lmp:'' };
        state.risks = { smoker:false, obesity:false, htn:false, dm:false, dyslipidemia:false, ckd:false, fhxPrematureCvd:false, fhxCrc:false };
        state.screening = { htn:'unknown', dm:'unknown', lipids:'unknown', hiv:'unknown', hcv:'unknown', crc:'unknown', cervical:'unknown', breast:'unknown', osteoporosis:'unknown', aaa:'unknown', depression:'unknown' };

        state.screeningDetails.crc = { done:null, lastDate:null, method:'', result:'unknown', fhxFDR:false, fhxAgeAtDx:'unknown', fhxNumFDR:'one', startAge:null, intervalYears:null, nextDue:null };

        state.screeningDetails.generic = JSON.parse(JSON.stringify({
          htn:{ done:null,lastDate:null,intervalType:'RISK_BASED',intervalYears:null,nextDue:null,note:'' },
          dm:{ done:null,lastDate:null,intervalType:'ANNUAL',intervalYears:1,nextDue:null,note:'' },
          lipids:{ done:null,lastDate:null,intervalType:'POLICY',intervalYears:null,nextDue:null,note:'' },
          hiv:{ done:null,lastDate:null,intervalType:'ONE_TIME',intervalYears:null,nextDue:null,note:'' },
          hcv:{ done:null,lastDate:null,intervalType:'ONE_TIME',intervalYears:null,nextDue:null,note:'' },

          cervical:{ done:null,lastDate:null,intervalType:'BY_METHOD',intervalYears:null,nextDue:null,note:'',method:'' },
          breast:{ done:null,lastDate:null,intervalType:'POLICY',intervalYears:null,nextDue:null,note:'',method:'MAMMO' },
          osteoporosis:{ done:null,lastDate:null,intervalType:'POLICY',intervalYears:null,nextDue:null,note:'',method:'DXA' },
          aaa:{ done:null,lastDate:null,intervalType:'ONE_TIME',intervalYears:null,nextDue:null,note:'',method:'US' },
          depression:{ done:null,lastDate:null,intervalType:'ANNUAL',intervalYears:1,nextDue:null,note:'',method:'PHQ' }
        }));

        // Vaccinations (if module exists)
        if(state.vaccinations){
          Object.keys(state.vaccinations).forEach(k=>{
            state.vaccinations[k].done = null;
            state.vaccinations[k].lastDate = null;
            state.vaccinations[k].nextDue = null;
          });
        }

        // Pregnancy (if module exists)
        if(state.pregnancy && state.pregnancy.items){
          Object.keys(state.pregnancy.items).forEach(k=>{
            state.pregnancy.items[k].done = null;
            state.pregnancy.items[k].date = null;
          });
        }

        state.results = [];
        state.exportText = '';
        go('welcome');
      ">Reset Session</div>
    </div>

    <div style="margin-top:12px">
      <textarea readonly>${state.exportText
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
      }</textarea>
    </div>
  `;

  setStatus("ok","Export ready");
}

/* =========================================================
   V2 BLOCK 2E
   VACCINATIONS: calc + render (policy-based, session-only)
   ========================================================= */

function calcVaxNextDue(key){
  const v = state.vaccinations[key];
  if(!v) return;

  v.nextDue = null;

  if(v.done !== true) return;
  if(!v.lastDate) return;

  if(v.intervalType === "ONE_TIME"){
    v.nextDue = null;
    return;
  }

  const years = (v.intervalYears !== null && v.intervalYears !== undefined) ? Number(v.intervalYears) : null;
  if(!years) return;

  v.nextDue = addYearsISO(v.lastDate, years);
}

function vaxRow(key, label, intervalOptions){
  const v = state.vaccinations[key];
  calcVaxNextDue(key);

  const status =
    v.done === true ? "Done" :
    v.done === false ? "Not done" :
    "Unknown";

  const nextText =
    (v.done === true && v.intervalType === "ONE_TIME") ? "N/A (one-time/series)" :
    (v.nextDue || "—");

  const intervalHtml = (v.intervalType === "POLICY") ? `
    <div class="field">
      <label>Policy interval</label>
      <select onchange="
        const n=this.value?Number(this.value):null;
        state.vaccinations['${key}'].intervalYears=n;
        renderVaccinations();
      ">
        <option value="" ${v.intervalYears===null?"selected":""}>— select —</option>
        ${intervalOptions.map(y=>`<option value="${y}" ${v.intervalYears===y?"selected":""}>Every ${y} year(s)</option>`).join("")}
      </select>
    </div>
  ` : `
    <div class="field">
      <label>Policy interval</label>
      <input type="text" value="One-time / series" readonly>
    </div>
  `;

  return `
    <div class="bucket">
      <div>
        <b>${label}</b><br>
        <small>${v.note || "Policy-based."}</small>
      </div>

      <select onchange="
        const val=this.value;
        if(val==='done'){ state.vaccinations['${key}'].done=true; }
        else if(val==='notdone'){ state.vaccinations['${key}'].done=false; }
        else { state.vaccinations['${key}'].done=null; }

        if(state.vaccinations['${key}'].done!==true){
          state.vaccinations['${key}'].lastDate=null;
          state.vaccinations['${key}'].nextDue=null;
        }
        renderVaccinations();
      ">
        <option value="unknown" ${v.done===null?"selected":""}>Unknown</option>
        <option value="done" ${v.done===true?"selected":""}>Done</option>
        <option value="notdone" ${v.done===false?"selected":""}>Not done</option>
      </select>
    </div>

    ${
      v.done === true ? `
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Date (Gregorian)</label>
            <input type="date" value="${v.lastDate ?? ""}"
              onchange="state.vaccinations['${key}'].lastDate=this.value||null; renderVaccinations();">
          </div>

          ${intervalHtml}

          <div class="field">
            <label>Next due (calculated)</label>
            <input type="text" value="${nextText}" readonly>
          </div>
        </div>
      ` : ``
    }

    <div class="results">
      <div class="item">
        <div class="top">
          <div><b>${label}</b></div>
          <span class="badge ${v.done===true ? "ok" : (v.done===false ? "due" : "high")}">${v.done===true ? "OK" : (v.done===false ? "DUE" : "CONSIDER")}</span>
        </div>
        <div class="msg">
          <div><b>Status:</b> ${status}</div>
          <div><b>Last date:</b> ${v.lastDate || "—"}</div>
          <div><b>Next due:</b> ${nextText}</div>
        </div>
      </div>
    </div>
  `;
}

function renderVaccinations(){
  // Policy-based tracker (eligibility rules will come later in V2 blocks)
  const html = `
    <div class="note">
      Vaccinations module is <b>session-only</b>. Intervals here are <b>policy-based</b> and editable.
      Eligibility rules and auto-hiding will be added in later V2 blocks.
    </div>

    ${vaxRow("influenza", "Influenza vaccine", [1])}
    ${vaxRow("covid19", "COVID-19 vaccine", [1,2])}
    ${vaxRow("tdap", "Tdap / Td booster", [10])}
    ${vaxRow("pneumococcal", "Pneumococcal vaccine", [])}
    ${vaxRow("hepB", "Hepatitis B vaccine (series)", [])}
    ${vaxRow("hpv", "HPV vaccine (series)", [])}
    ${vaxRow("zoster", "Herpes Zoster (Shingles) vaccine", [])}

    <div class="btns">
      <div class="btn" onclick="go('screening')">Back</div>
      <div class="btn primary" onclick="go('results')">Go to Results</div>
      <div class="btn" onclick="go('export')">Export</div>
    </div>
  `;

  $("leftPane").innerHTML = html;
  setStatus("ok","Vaccinations");
}

/* =========================================================
   V2 BLOCK 7B
   Session-only flags + counts
   ========================================================= */

function addFlag(title, detail){
  state.flags.push({ title, detail });
}

function computeFlagsAndCounts(){
  state.flags = [];

  const d = state.demographics;

  // --- Pregnancy flags
  if(d.sex === "female" && d.pregnant === true && !d.lmp){
    addFlag("Pregnancy: LMP missing", "Pregnant = Yes but LMP is empty. GA/EDD cannot be calculated.");
  }

  // --- Generic screening: done but missing date
  const g = state.screeningDetails?.generic || {};
  Object.keys(g).forEach(k=>{
    const obj = g[k];
    if(obj && obj.done === true && !obj.lastDate){
      addFlag(`Screening: ${k} missing date`, "Marked as Done but last date is missing.");
    }
  });

  // --- CRC consistency
  const crc = state.screeningDetails?.crc;
  if(crc && crc.done === true){
    if(!crc.lastDate) addFlag("CRC: missing date", "CRC marked as Done but last date is missing.");
    if(!crc.method) addFlag("CRC: missing method", "CRC marked as Done but method is not selected.");
  }

  // --- Vaccinations: done but missing date (policy-type only)
  if(state.vaccinations){
    Object.keys(state.vaccinations).forEach(k=>{
      const v = state.vaccinations[k];
      if(v && v.done === true && v.intervalType === "POLICY" && !v.lastDate){
        addFlag(`Vaccination: ${k} missing date`, "Marked as Done but date is missing.");
      }
    });
  }

  // --- Pregnancy items: done but missing date
  if(state.pregnancy && state.pregnancy.items){
    Object.keys(state.pregnancy.items).forEach(k=>{
      const it = state.pregnancy.items[k];
      if(it && it.done === true && !it.date){
        addFlag(`Pregnancy item: ${k} missing date`, "Marked as Done but date is missing.");
      }
    });
  }

  // Counts (computed on the fly in Results)
}

function countDueConsiderOk(){
  const due = state.results.filter(x=>x.level==="DUE").length;
  const consider = state.results.filter(x=>x.level==="CONSIDER").length;
  const ok = state.results.filter(x=>x.level==="OK").length;
  return { due, consider, ok };
}

function countModuleDue(){
  // Screening due: based on state.results titles (best-effort)
  const screeningDue = state.results.filter(x=>x.level==="DUE").length;

  // Vaccinations due: Not done (done=false) OR done=true but overdue (policy with nextDue <= today)
  let vaxDue = 0;
  if(state.vaccinations){
    Object.keys(state.vaccinations).forEach(k=>{
      const v = state.vaccinations[k];
      if(!v) return;

      if(v.done === false) { vaxDue++; return; }
      if(v.done === true && v.intervalType === "POLICY" && v.nextDue && isOnOrBeforeISO(v.nextDue, todayISO())) { vaxDue++; return; }
    });
  }

  // Pregnancy due: GA-based due window (if GA exists) and not done
  let pregDue = 0;
  if(state.pregnancy && state.pregnancy.items){
    const ga = (typeof getGAWeeksFromState === "function") ? getGAWeeksFromState() : null;
    if(ga !== null){
      // windows must match the ones used in renderPregnancyPanel
      const windows = {
        datingScan: [8,13],
        nipt: [10,13],
        anomalyScan: [18,22],
        gdmScreen: [24,28],
        gbs: [35,37]
      };
      Object.keys(windows).forEach(k=>{
        const it = state.pregnancy.items[k];
        if(!it) return;
        const [s,e] = windows[k];
        const st = gaWindowStatus(ga, it.done, s, e);
        if(st === "DUE_NOW" || st === "OVERDUE") pregDue++;
      });
    }
  }

  return { screeningDue, vaxDue, pregDue };
}


/* =========================================================
   V2 BLOCK 3C
   Pregnancy panel (GA-based) inside Screening
   ========================================================= */

function pregnancyItemRow(key, label, startW, endW){
  const p = state.pregnancy.items[key];
  const ga = getGAWeeksFromState();

  const st = gaWindowStatus(ga, p.done, startW, endW);

  const badge =
    st === "DONE" ? `<span class="badge ok">OK</span>` :
    st === "DUE_NOW" ? `<span class="badge due">DUE</span>` :
    st === "OVERDUE" ? `<span class="badge due">OVERDUE</span>` :
    st === "NOT_YET" ? `<span class="badge high">NOT YET</span>` :
    `<span class="badge high">—</span>`;

  const statusText =
    st === "DONE" ? "Done" :
    st === "DUE_NOW" ? "Due now" :
    st === "OVERDUE" ? "Overdue" :
    st === "NOT_YET" ? "Not yet" :
    "—";

  return `
    <div class="bucket">
      <div>
        <b>${label}</b><br>
        <small>Due window: GA ${startW}–${endW} weeks.</small>
      </div>

      <select onchange="
        const v=this.value;
        if(v==='done'){ state.pregnancy.items['${key}'].done=true; }
        else if(v==='notdone'){ state.pregnancy.items['${key}'].done=false; }
        else { state.pregnancy.items['${key}'].done=null; }

        if(state.pregnancy.items['${key}'].done!==true){
          state.pregnancy.items['${key}'].date=null;
        }
        renderScreening();
      ">
        <option value="unknown" ${p.done===null?"selected":""}>Unknown</option>
        <option value="done" ${p.done===true?"selected":""}>Done</option>
        <option value="notdone" ${p.done===false?"selected":""}>Not done</option>
      </select>
    </div>

    ${
      p.done === true ? `
        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Date performed (Gregorian)</label>
            <input type="date" value="${p.date ?? ""}"
              onchange="state.pregnancy.items['${key}'].date=this.value||null; renderScreening();">
          </div>
          <div class="field">
            <label>Status (GA-based)</label>
            <input type="text" value="${statusText}" readonly>
          </div>
          <div class="field">
            <label>Note</label>
            <input type="text" value="${p.note || ""}" readonly>
          </div>
        </div>
      ` : `
        <div class="results">
          <div class="item">
            <div class="top">
              <div><b>${label}</b></div>
              ${badge}
            </div>
            <div class="msg">
              <div><b>Status:</b> ${statusText}</div>
              <div><b>Note:</b> ${p.note || "—"}</div>
            </div>
          </div>
        </div>
      `
    }
  `;
}

function renderPregnancyPanel(){
  const ga = getGAWeeksFromState();
  const edd = getEDDFromLMP();

  if(ga === null) return `
    <div class="note" style="margin-top:12px">
      Pregnancy pathway is available when Sex = Female, Pregnant = Yes, and LMP is entered.
    </div>
  `;

  return `
    <div class="note" style="margin-top:12px">
      <b>Pregnancy pathway (GA-based)</b><br>
      GA (weeks): <b>${ga}</b><br>
      EDD (from LMP): <b>${edd || "—"}</b><br>
      Session-only tracking. Windows are policy-based and editable in future V2 blocks.
    </div>

    ${pregnancyItemRow("datingScan","Dating / NT scan",8,13)}
    ${pregnancyItemRow("nipt","NIPT / cfDNA",10,13)}
    ${pregnancyItemRow("anomalyScan","Anomaly scan",18,22)}
    ${pregnancyItemRow("gdmScreen","GDM screening",24,28)}
    ${pregnancyItemRow("gbs","GBS screening",35,37)}
  `;
}
/* =========================================================
   V2 BLOCK 4B
   Screening UX helpers: eligibility + sorting (Due first)
   ========================================================= */

function bucketPriority(bucket){
  // Lower number = higher priority (show earlier)
  if(bucket === "overdue" || bucket === "never") return 0;
  if(bucket === "unknown") return 1;
  if(bucket === "recent") return 2;
  return 1;
}

function renderNotEligibleBlock(title, reason){
  return `
    <div class="results">
      <div class="item">
        <div class="top">
          <div><b>${title}</b></div>
          <span class="badge high">N/A</span>
        </div>
        <div class="msg">${reason}</div>
      </div>
    </div>
  `;
}

function pushScreeningSection(list, key, html){
  const bucket = state.screening[key] || "unknown";
  list.push({
    key,
    pr: bucketPriority(bucket),
    order: list.length,
    html
  });
}


/* =========================
   INIT
   ========================= */
wireNav();
go("welcome");
</script>
